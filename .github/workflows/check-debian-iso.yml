name: Check for new Debian ISO

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-debian-iso:
    runs-on: ubuntu-latest
    env:
      ISO_URL_BASE: "https://get.debian.org/images/release/current/amd64/iso-cd/"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current ISO version
        id: current
        run: |
          CURRENT=$(grep -Po '(?<=iso_name = ")[^"]*' debian.auto.pkrvars.hcl)
          echo "iso=$CURRENT" >> $GITHUB_OUTPUT

      - name: Get latest ISO version from Debian site
        id: latest
        run: |
          LATEST=$(curl -s ${{ env.ISO_URL_BASE }} | grep -Po 'debian-\d+\.\d+\.\d+-amd64-netinst\.iso' | head -n1)
          echo "iso=$LATEST" >> $GITHUB_OUTPUT

      - name: Compare versions and update if necessary
        id: pr
        if: steps.latest.outputs.iso != steps.current.outputs.iso
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          sed -i "s/${{ steps.current.outputs.iso }}/${{ steps.latest.outputs.iso }}/" debian.auto.pkrvars.hcl

          NEW_BRANCH="update-debian-iso-${{ steps.latest.outputs.iso }}"

          if git show-ref --verify --quiet refs/heads/"$NEW_BRANCH"; then
            echo "Branch $NEW_BRANCH already exists. Exiting."
            exit 0
          fi

          git checkout -b "$NEW_BRANCH"
          git add debian.auto.pkrvars.hcl
          git commit -m "Update Debian ISO to ${{ steps.latest.outputs.iso }}"
          git push origin "$NEW_BRANCH"

          PR_URL=$(gh pr create \
            --title "chore: bump Debian ISO to ${{ steps.latest.outputs.iso }}" \
            --body "New Debian ISO detected and updated: \`${{ steps.latest.outputs.iso }}\`" \
            --head "$NEW_BRANCH" \
            --base main)

          echo "url=$PR_URL" >> $GITHUB_OUTPUT
      
      - name: Comment on Pull Request
        if: steps.latest.outputs.iso != steps.current.outputs.iso
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ steps.pr.outputs.url }} --body '''
          ðŸ†• **Debian ISO Updated**

          **Download:** [${{ steps.latest.outputs.iso }}](${{ env.ISO_URL_BASE }}${{ steps.latest.outputs.iso }})

          This PR updates the \`iso_name\` variable in \`debian.auto.pkrvars.hcl\` to use the latest ISO available.'''
